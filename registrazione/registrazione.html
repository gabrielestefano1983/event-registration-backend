<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrazione Evento</title>
</head>

<body style="margin: 0; padding: 0; background-color: transparent;">

    <div id="event-reg-root"
        style="max-width: 600px; margin: 20px auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; border: 1px solid #e1e1e1; border-radius: 12px; background: #ffffff; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden;">

        <div style="background: #f8f9fa; padding: 25px; border-bottom: 1px solid #eee;">
            <h2 style="margin: 0; color: #1a1a1a; font-size: 1.6rem; letter-spacing: -0.5px;">Registrazione Evento</h2>
            <p style="margin: 8px 0 0; color: #666; font-size: 0.95rem; line-height: 1.4;">
                Il referente (Capogruppo) ricever√† tutti i biglietti via email.
            </p>
        </div>

        <div style="padding: 25px;">

            <div id="leader-section"
                style="padding: 20px; border: 2px solid #3182ce; border-radius: 12px; background: #ebf8ff; margin-bottom: 25px;">
                <span
                    style="font-weight: 800; font-size: 0.75rem; color: #3182ce; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 12px;">
                    üü¢ Capogruppo / Referente (Obbligatorio)
                </span>
                <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                    <input type="text" id="leader-name" placeholder="Nome e Cognome completo" value=""
                        style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box;">

                    <div>
                        <input type="email" id="leader-email" placeholder="Email per ricevere i biglietti" value=""
                            style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box; outline: none; transition: border-color 0.2s;">
                        <div id="email-error"
                            style="color: #e53e3e; font-size: 0.75rem; margin-top: 5px; display: none; font-weight: 600;">
                            Inserisci un indirizzo email valido.</div>
                    </div>

                    <input type="tel" id="leader-telefono" placeholder="Numero di telefono *" required value=""
                        style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box;">

                    <textarea id="leader-note" placeholder="Note (allergie, esigenze speciali - opzionale)"
                        style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box; resize:vertical; min-height:60px; font-family:inherit;"></textarea>

                    <div id="leader-ticket-label"
                        style="font-size: 0.9rem; color: #2c5282; font-weight: 700; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #bee3f8;">
                        Biglietto: Maggiore 18 anni (‚Ç¨10.00)
                    </div>
                </div>
            </div>

            <h4
                style="margin: 0 0 15px; color: #4a5568; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Altri Partecipanti</h4>

            <div id="extras-list"></div>

            <button type="button" id="add-btn"
                style="width: 100%; padding: 14px; margin-top: 10px; background: #fff; border: 2px dashed #cbd5e0; border-radius: 10px; color: #4a5568; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem;">
                + Aggiungi un altro partecipante
            </button>

            <div
                style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #edf2f7; text-align: right;">
                <span
                    style="display: block; color: #718096; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; margin-bottom: 4px;">Totale
                    da pagare</span>
                <div id="total-display"
                    style="font-size: 2.5rem; font-weight: 900; color: #2d3748; letter-spacing: -1px;">
                    10.00‚Ç¨</div>
            </div>

            <div style="margin-top: 25px;">
                <div id="paypal-button-container" style="min-height: 150px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect locale vs produzione
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8888/api'
            : 'https://poetic-phoenix-66e16b.netlify.app/api';

        // Leggi eventId dall'URL (?event=123)
        const urlParams = new URLSearchParams(window.location.search);
        const EVENT_ID = urlParams.get('event');

        // ‚ö†Ô∏è VALIDAZIONE: Blocca se manca eventId
        if (!EVENT_ID) {
            document.body.innerHTML = `
                <div style="max-width: 600px; margin: 50px auto; padding: 30px; text-align: center; font-family: Arial, sans-serif;">
                    <h1 style="color: #e53e3e;">‚ö†Ô∏è Parametro Mancante</h1>
                    <p style="font-size: 18px; color: #4a5568; margin: 20px 0;">
                        Per accedere alla registrazione √® necessario specificare un evento valido.
                    </p>
                    <p style="color: #718096;">
                        L'URL deve includere il parametro <code style="background: #f7fafc; padding: 2px 6px; border-radius: 4px;">?event=ID</code>
                    </p>
                    <p style="margin-top: 30px;">
                        <strong>Esempio:</strong><br>
                        <code style="background: #f7fafc; padding: 8px 12px; border-radius: 4px; display: inline-block; margin-top: 10px;">
                            registrazione.html?event=1
                        </code>
                    </p>
                </div>
            `;
            throw new Error('EventId mancante nell\'URL');
        }

        // Carica configurazione PayPal dal server in modo sicuro
        async function loadPayPalSDK() {
            const configUrl = `${API_BASE}/config?event=${EVENT_ID}`;
            const configRes = await fetch(configUrl);

            if (!configRes.ok) {
                const errorData = await configRes.json();
                throw new Error(errorData.reason || errorData.error || 'Evento non disponibile');
            }

            const config = await configRes.json();
            window.evtConfig = config; // Store config globally (labels + prezzi + event info)

            // Mostra nome evento se presente
            if (config.nomeEvento && config.nomeEvento !== 'Registrazione') {
                document.querySelector('h2').innerText = config.nomeEvento;
                if (config.descrizione) {
                    const desc = document.querySelector('h2').nextElementSibling;
                    desc.innerText = config.descrizione;
                }
            }

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://www.paypal.com/sdk/js?client-id=${config.paypalClientId}&currency=${config.currency}`;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Inizializza l'app dopo aver caricato PayPal SDK
        loadPayPalSDK().then(() => {
            window.scrollTo(0, 0); // Force scroll to top
            initApp();
        }).catch(err => {
            console.error('Errore caricamento PayPal SDK:', err);
            alert(err.message || 'Errore nel caricamento del sistema di pagamento. Riprova pi√π tardi.');
        });

        function initApp() {
            // Stato dell'applicazione - con valori di default per testing
            let leaderData = {
                nome: '',
                email: '',
                telefono: '',
                note: '',
                tipo: 'adulto'
            };
            let extraParticipants = []; // Solo gli altri

            const extrasListEl = document.getElementById('extras-list');
            const totalEl = document.getElementById('total-display');
            const paypalContainer = document.getElementById('paypal-button-container');

            // Utility Validazione Email
            function validateEmailFormat(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase().trim());
            }

            // Calcola e aggiorna il totale
            function updateTotal() {
                const prezzi = window.evtConfig?.prezzi || { adulto: 10, ragazzo: 5, minore: 0 };
                let totale = prezzi.adulto; // Il leader √® sempre adulto
                extraParticipants.forEach(p => { totale += prezzi[p.tipo]; });
                totalEl.innerText = totale.toFixed(2) + '‚Ç¨';
            }

            // Aggiorna etichetta capogruppo (solo visiva)
            if (window.evtConfig && window.evtConfig.tipoLabels) {
                const lLabel = window.evtConfig.tipoLabels['adulto'] || 'Maggiore 18 anni';
                const lPrice = (window.evtConfig.prezzi?.adulto || 10).toFixed(2);
                const el = document.getElementById('leader-ticket-label');
                if (el) el.innerText = `Biglietto: ${lLabel} (‚Ç¨${lPrice})`;
            }

            // Renderizza solo i partecipanti extra (cos√¨ non tocchiamo il leader)
            function renderExtras() {
                extrasListEl.innerHTML = '';
                const labels = window.evtConfig && window.evtConfig.tipoLabels ? window.evtConfig.tipoLabels : {
                    'adulto': 'Maggiore 18 anni',
                    'ragazzo': 'Tra 12 e 18 anni',
                    'minore': 'Minore 12 anni'
                };
                const prezzi = window.evtConfig?.prezzi || { adulto: 10, ragazzo: 5, minore: 0 };

                extraParticipants.forEach((p, i) => {
                    const div = document.createElement('div');
                    // Stile "Card" simile al Capogruppo ma con colori neutri/distinti
                    div.style = "position: relative; margin-bottom: 20px; padding: 20px; border: 2px solid #cbd5e0; border-radius: 12px; background: #fff;";

                    // Genera opzioni dinamicamente
                    const optionsHtml = Object.keys(prezzi).map(k => {
                        const label = labels[k] || k;
                        const price = prezzi[k] === 0 ? 'Gratis' : `‚Ç¨${prezzi[k].toFixed(2)}`;
                        return `<option value="${k}" ${p.tipo === k ? 'selected' : ''}>${label} (${price})</option>`;
                    }).join('');

                    div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 800; font-size: 0.75rem; color: #4a5568; text-transform: uppercase; letter-spacing: 1px;">
                            üë§ Partecipante #${i + 2}
                        </span>
                        <button type="button" onclick="removeExtra(${i})" 
                            style="background:none; border:none; color:#e53e3e; cursor:pointer; font-size:0.75rem; font-weight:700; text-transform: uppercase; letter-spacing: 0.5px;">
                            Rimuovi ‚úï
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <input type="text" placeholder="Nome e Cognome" class="ex-nome" data-idx="${i}" value="${p.nome}" 
                            style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box;">
                        
                        <select class="ex-tipo" data-idx="${i}" 
                            style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; background:white; font-size:1rem; box-sizing: border-box;">
                            ${optionsHtml}
                        </select>
                        
                        <textarea placeholder="Note (allergie, esigenze speciali - opzionale)" class="ex-note" data-idx="${i}" 
                            style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; font-size:1rem; box-sizing: border-box; resize:vertical; min-height:60px; font-family:inherit;">${p.note || ''}</textarea>
                    </div>
                `;
                    extrasListEl.appendChild(div);
                });
                bindExtraListeners();
                updateTotal();
            }

            // Listener per il Leader (fissi, non cambiano mai)
            const leaderEmailInput = document.getElementById('leader-email');
            const leaderNameInput = document.getElementById('leader-name');
            const leaderTelefonoInput = document.getElementById('leader-telefono');
            const leaderNoteInput = document.getElementById('leader-note');

            leaderNameInput.oninput = (e) => { leaderData.nome = e.target.value; };
            leaderEmailInput.oninput = (e) => { leaderData.email = e.target.value; };
            leaderTelefonoInput.oninput = (e) => { leaderData.telefono = e.target.value; };
            leaderNoteInput.oninput = (e) => { leaderData.note = e.target.value; };

            leaderEmailInput.onblur = (e) => {
                const val = e.target.value.trim();
                const errorDiv = document.getElementById('email-error');
                if (val !== "" && !validateEmailFormat(val)) {
                    e.target.style.borderColor = "#e53e3e";
                    e.target.style.borderWidth = "2px";
                    errorDiv.style.display = "block";
                } else {
                    e.target.style.borderColor = "#cbd5e0";
                    e.target.style.borderWidth = "1px";
                    errorDiv.style.display = "none";
                }
            };

            function bindExtraListeners() {
                document.querySelectorAll('.ex-nome').forEach(el => {
                    el.oninput = (e) => { extraParticipants[e.target.dataset.idx].nome = e.target.value; };
                });
                document.querySelectorAll('.ex-tipo').forEach(el => {
                    el.onchange = (e) => {
                        extraParticipants[e.target.dataset.idx].tipo = e.target.value;
                        updateTotal();
                    };
                });
                document.querySelectorAll('.ex-note').forEach(el => {
                    el.oninput = (e) => { extraParticipants[e.target.dataset.idx].note = e.target.value; };
                });
            }

            window.removeExtra = (i) => { extraParticipants.splice(i, 1); renderExtras(); };
            document.getElementById('add-btn').onclick = () => {
                extraParticipants.push({ nome: '', tipo: 'adulto', note: '' });
                renderExtras();
            };

            // Unifica i dati per il backend
            function getFullData() {
                return [leaderData, ...extraParticipants];
            }

            function validateAll() {
                if (!leaderData.nome || !leaderData.email || !validateEmailFormat(leaderData.email)) {
                    alert("Dati Capogruppo mancanti o email non valida!");
                    return false;
                }
                if (!leaderData.telefono || leaderData.telefono.trim() === '') {
                    alert("Il numero di telefono del Capogruppo √® obbligatorio!");
                    return false;
                }
                for (let p of extraParticipants) {
                    if (!p.nome) { alert("Inserisci il nome di tutti i partecipanti extra."); return false; }
                }
                return true;
            }

            // PAYPAL
            paypal.Buttons({
                fundingSource: paypal.FUNDING.PAYPAL,
                createOrder: async (data, actions) => {
                    if (!validateAll()) return actions.reject();
                    const res = await fetch(`${API_BASE}/create-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            eventId: EVENT_ID,
                            participants: getFullData()
                        })
                    });
                    const order = await res.json();
                    return order.id;
                },
                onApprove: async (data) => {
                    const res = await fetch(`${API_BASE}/capture-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            eventId: EVENT_ID,
                            participants: getFullData()
                        })
                    });
                    if (res.ok) {
                        // Redirect alla pagina di successo con email
                        window.location.href = `/registrazione/success.html?email=${encodeURIComponent(leaderData.email)}`;
                    } else {
                        alert('Si √® verificato un errore. Contattaci se il problema persiste.');
                    }
                }
            }).render('#paypal-button-container');

            renderExtras(); // Avvio
        }
    </script>
</body>

</html>