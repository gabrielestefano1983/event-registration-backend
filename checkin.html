<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Check-in Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background: #fff;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        /* MAIN VIEWS */
        .view {
            flex: 1;
            padding: 1rem;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .view.active {
            display: flex;
        }

        /* SCANNER VIEW */
        #reader {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .btn-large:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
            margin-top: 20px;
        }

        /* RESULT VIEW */
        .result-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 350px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .icon {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
        }

        .status-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .detail-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 5px;
        }

        .sub-detail {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }

        /* COLORS */
        .status-ok .icon {
            color: #28a745;
        }

        .status-ok .status-text {
            color: #28a745;
        }

        .status-ko .icon {
            color: #dc3545;
        }

        .status-ko .status-text {
            color: #dc3545;
        }

        .status-warn .icon {
            color: #ffc107;
        }

        .status-warn .status-text {
            color: #d39e00;
        }

        /* Manual Input */
        .manual-input {
            margin-top: 30px;
            width: 100%;
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        input {
            /* Manual Input Removed */

            @keyframes popIn {
                from {
                    transform: scale(0.8);
                    opacity: 0;
                }

                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }
    </style>
</head>

<body>

    <header>
        <h1>Staff Check-in</h1>
    </header>

    <!-- VIEW 1: SCANNER -->
    <div id="view-scan" class="view active">
        <div id="reader"></div>

        <button onclick="startScanner()" id="btnStart" class="btn-large btn-primary">üì∑ Scansiona QR</button>
        <button onclick="stopScanner()" id="btnStop" class="btn-large btn-danger" style="display:none;">Stop</button>
    </div>

    <!-- VIEW 2: RESULT -->
    <div id="view-result" class="view">
        <div id="result-card" class="result-card">
            <!-- Content filled by JS -->
        </div>
        <button onclick="resetScanner()" class="btn-large btn-primary" style="margin-top: 30px;">Scansiona
            Prossimo</button>
    </div>

    <!-- VIEW 3: LOADING -->
    <div id="view-loading" class="view">
        <div class="result-card">
            <span class="icon">‚è≥</span>
            <span class="status-text" style="color:#666">Verifica in corso...</span>
        </div>
    </div>

    <script>
        let html5QrcodeScanner;
        let isScanning = false;

        // UI SWITCHING
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // SCANNER LOGIC
        async function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return;
            isScanning = false;

            // Stop noise/feedback loop
            await stopScanner();

            // Call API
            doCheckIn(decodedText);
        }

        function startScanner() {
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'block';

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };

            isScanning = true;
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    alert("Errore avvio fotocamera: " + err);
                    resetScanner();
                });
        }

        async function stopScanner() {
            if (html5QrcodeScanner) {
                try {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner.clear();
                } catch (e) { console.error(e); }
                html5QrcodeScanner = null;
            }
            isScanning = false;
            document.getElementById('btnStart').style.display = 'inline-block';
            document.getElementById('btnStop').style.display = 'none';
        }

        function resetScanner() {
            stopScanner(); // Ensure stopped
            document.getElementById('tokenInput').value = "";
            document.getElementById('reader').innerHTML = ""; // Clear placeholder
            showView('view-scan');
        }

        // API CALL
        async function doCheckIn(token) {
            showView('view-loading');

            try {
                const response = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qr_token: token })
                });

                const data = await response.json();
                showResult(response.status, data);

            } catch (e) {
                showResult(500, { message: "Errore di rete: " + e.message });
            }
        }

        function showResult(status, data) {
            const card = document.getElementById('result-card');
            let html = '';
            let statusClass = '';

            if (status === 200) {
                // SUCCESS
                statusClass = 'status-ok';
                html = `
                    <span class="icon">‚úÖ</span>
                    <span class="status-text">BIGLIETTO VALIDO</span>
                    <div class="detail-text">${data.message.replace('Benvenuto/a ', '')}</div>
                    <div class="sub-detail">Tipologia: <strong>${data.tipo.toUpperCase()}</strong></div>
                `;
            } else if (status === 400) {
                // WARNING (Gi√† usato)
                statusClass = 'status-warn';
                html = `
                    <span class="icon">‚ö†Ô∏è</span>
                    <span class="status-text">GI√Ä ENTRATO</span>
                    <div class="detail-text">Questo biglietto √® gi√† stato utilizzato.</div>
                `;
            } else {
                // ERROR (404 o altro)
                statusClass = 'status-ko';
                html = `
                    <span class="icon">‚õî</span>
                    <span class="status-text">NON VALIDO</span>
                    <div class="detail-text">${data.message || 'Biglietto non trovato'}</div>
                `;
            }

            card.className = `result-card ${statusClass}`;
            card.innerHTML = html;
            showView('view-result');
        }
    </script>
</body>

</html>